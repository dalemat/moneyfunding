(function(){"use strict";var e=flarum.core.compat,t=e.extend,n=e["Component"],r=e["components/Button"],i=e["components/Switch"],o=e["components/FieldSet"],a=e["components/LoadingIndicator"],s=e["utils/Stream"],l=e.app,c=e["components/AdminPage"],u=function(e){function t(){e.apply(this,arguments),this.loading=!1,this.saving=!1,this.testing=!1,this.testResult=null,this.ethereumRpcUrl=s(""),this.contractAddress=s(""),this.walletAddress=s(""),this.conversionRate=s(100),this.minDeposit=s(10),this.autoVerification=s(!0),this.requireConfirmations=s(3),this.enableNotifications=s(!0),this.debugMode=s(!1),this.statistics={totalTransactions:0,confirmedTransactions:0,pendingTransactions:0,failedTransactions:0,totalVolume:0,totalPointsIssued:0}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.oninit=function(){e.prototype.oninit.call(this),this.loadSettings(),this.loadStatistics()},t.prototype.className=function(){return"ERC20SettingsPage"},t.prototype.heading=function(){return l.translator.trans("cryptofund-erc20-money.admin.settings.title")},t.prototype.content=function(){return m("div",{className:"ERC20Settings"},[this.loading?m(a):null,this.loading?null:[m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.connection_title"),className:"ERC20Settings-section"},this.renderConnectionSettings()),m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.token_title"),className:"ERC20Settings-section"},this.renderTokenSettings()),m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.conversion_title"),className:"ERC20Settings-section"},this.renderConversionSettings()),m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.verification_title"),className:"ERC20Settings-section"},this.renderVerificationSettings()),m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.advanced_title"),className:"ERC20Settings-section"},this.renderAdvancedSettings()),m(o,{label:l.translator.trans("cryptofund-erc20-money.admin.settings.statistics_title"),className:"ERC20Settings-section"},this.renderStatistics()),this.renderActions()]])},t.prototype.renderConnectionSettings=function(){var e=this;return[m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.ethereum_rpc_url")),m("input",{className:"FormControl",type:"url",placeholder:"https://mainnet.infura.io/v3/YOUR-PROJECT-ID",value:this.ethereumRpcUrl(),oninput:function(t){e.ethereumRpcUrl(t.target.value)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.ethereum_rpc_url_help"))]),m("div",{className:"Form-group"},[m("div",{className:"ERC20Settings-testConnection"},[m(r,{className:"Button Button--primary",loading:this.testing,disabled:!this.ethereumRpcUrl()||this.testing,onclick:function(){e.testConnection()}},l.translator.trans("cryptofund-erc20-money.admin.settings.test_connection")),this.testResult?m("div",{className:"ERC20Settings-testResult ERC20Settings-testResult--"+(this.testResult.success?"success":"error")},this.testResult.message):null])])]},t.prototype.renderTokenSettings=function(){var e=this;return[m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.contract_address")),m("input",{className:"FormControl",type:"text",placeholder:"0x...",value:this.contractAddress(),oninput:function(t){e.contractAddress(t.target.value)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.contract_address_help"))]),m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.wallet_address")),m("input",{className:"FormControl",type:"text",placeholder:"0x...",value:this.walletAddress(),oninput:function(t){e.walletAddress(t.target.value)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.wallet_address_help"))])]},t.prototype.renderConversionSettings=function(){var e=this;return[m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.conversion_rate")),m("input",{className:"FormControl",type:"number",min:"1",step:"1",value:this.conversionRate(),oninput:function(t){e.conversionRate(parseInt(t.target.value)||100)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.conversion_rate_help"))]),m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.min_deposit")),m("input",{className:"FormControl",type:"number",min:"0.000001",step:"0.000001",value:this.minDeposit(),oninput:function(t){e.minDeposit(parseFloat(t.target.value)||10)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.min_deposit_help"))]),m("div",{className:"Form-group"},[m("div",{className:"ERC20Settings-preview"},[m("strong",l.translator.trans("cryptofund-erc20-money.admin.settings.conversion_preview")),m("div",{className:"ERC20Settings-previewText"},l.translator.trans("cryptofund-erc20-money.admin.settings.conversion_example",{tokens:this.minDeposit(),points:Math.floor(this.minDeposit()*this.conversionRate())}))])])]},t.prototype.renderVerificationSettings=function(){var e=this;return[m("div",{className:"Form-group"},[m(i,{state:this.autoVerification(),onchange:function(t){e.autoVerification(t)}},l.translator.trans("cryptofund-erc20-money.admin.settings.auto_verification")),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.auto_verification_help"))]),m("div",{className:"Form-group"},[m("label",l.translator.trans("cryptofund-erc20-money.admin.settings.require_confirmations")),m("input",{className:"FormControl",type:"number",min:"1",max:"50",value:this.requireConfirmations(),oninput:function(t){e.requireConfirmations(parseInt(t.target.value)||3)}}),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.require_confirmations_help"))])]},t.prototype.renderAdvancedSettings=function(){var e=this;return[m("div",{className:"Form-group"},[m(i,{state:this.enableNotifications(),onchange:function(t){e.enableNotifications(t)}},l.translator.trans("cryptofund-erc20-money.admin.settings.enable_notifications")),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.enable_notifications_help"))]),m("div",{className:"Form-group"},[m(i,{state:this.debugMode(),onchange:function(t){e.debugMode(t)}},l.translator.trans("cryptofund-erc20-money.admin.settings.debug_mode")),m("div",{className:"helpText"},l.translator.trans("cryptofund-erc20-money.admin.settings.debug_mode_help"))])]},t.prototype.renderStatistics=function(){var e=this.statistics;return m("div",{className:"ERC20Settings-statistics"},[m("div",{className:"ERC20Settings-statsGrid"},[m("div",{className:"ERC20Settings-statItem"},[m("div",{className:"ERC20Settings-statValue"},e.totalTransactions),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.total_transactions"))]),m("div",{className:"ERC20Settings-statItem ERC20Settings-statItem--success"},[m("div",{className:"ERC20Settings-statValue"},e.confirmedTransactions),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.confirmed_transactions"))]),m("div",{className:"ERC20Settings-statItem ERC20Settings-statItem--warning"},[m("div",{className:"ERC20Settings-statValue"},e.pendingTransactions),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.pending_transactions"))]),m("div",{className:"ERC20Settings-statItem ERC20Settings-statItem--danger"},[m("div",{className:"ERC20Settings-statValue"},e.failedTransactions),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.failed_transactions"))]),m("div",{className:"ERC20Settings-statItem ERC20Settings-statItem--primary"},[m("div",{className:"ERC20Settings-statValue"},e.totalVolume.toFixed(6)),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.total_volume"))]),m("div",{className:"ERC20Settings-statItem ERC20Settings-statItem--info"},[m("div",{className:"ERC20Settings-statValue"},e.totalPointsIssued),m("div",{className:"ERC20Settings-statLabel"},l.translator.trans("cryptofund-erc20-money.admin.settings.total_points_issued"))])]),m("div",{className:"ERC20Settings-statsActions"},[m(r,{className:"Button",onclick:this.loadStatistics.bind(this)},[m("i",{className:"fa fa-refresh"})," "+l.translator.trans("cryptofund-erc20-money.admin.settings.refresh_stats")])])])},t.prototype.renderActions=function(){var e=this;return m("div",{className:"ERC20Settings-actions"},[m(r,{className:"Button Button--primary",type:"submit",loading:this.saving,disabled:this.saving,onclick:function(){e.saveSettings()}},l.translator.trans("cryptofund-erc20-money.admin.settings.save_button")),m(r,{className:"Button",onclick:function(){e.loadSettings()}},l.translator.trans("cryptofund-erc20-money.admin.settings.reset_button")),m(r,{className:"Button Button--danger",onclick:function(){e.runManualCheck()}},[m("i",{className:"fa fa-play"})," "+l.translator.trans("cryptofund-erc20-money.admin.settings.manual_check_button")])])},t.prototype.loadSettings=function(){var e=this;return this.loading=!0,l.request({method:"GET",url:l.forum.attribute("apiUrl")+"/erc20-settings"}).then(function(t){var n=t.data.attributes;e.ethereumRpcUrl(n.ethereum_rpc_url||""),e.contractAddress(n.contract_address||""),e.walletAddress(n.wallet_address||""),e.conversionRate(n.conversion_rate||100),e.minDeposit(n.min_deposit||10),e.autoVerification(!1!==n.auto_verification),e.requireConfirmations(n.require_confirmations||3),e.enableNotifications(!1!==n.enable_notifications),e.debugMode(!0===n.debug_mode),e.loading=!1,m.redraw()}).catch(function(t){console.error("Failed to load settings:",t),e.loading=!1,m.redraw()})},t.prototype.saveSettings=function(){var e=this;return this.saving=!0,l.request({method:"POST",url:l.forum.attribute("apiUrl")+"/erc20-settings",body:{data:{type:"erc20-settings",attributes:{ethereum_rpc_url:this.ethereumRpcUrl(),contract_address:this.contractAddress(),wallet_address:this.walletAddress(),conversion_rate:this.conversionRate(),min_deposit:this.minDeposit(),auto_verification:this.autoVerification(),require_confirmations:this.requireConfirmations(),enable_notifications:this.enableNotifications(),debug_mode:this.debugMode()}}}}).then(function(t){e.saving=!1,l.alerts.show({type:"success"},l.translator.trans("cryptofund-erc20-money.admin.settings.saved")),m.redraw()}).catch(function(t){e.saving=!1;var n=t.responseJSON&&t.responseJSON.errors&&t.responseJSON.errors[0]?t.responseJSON.errors[0].detail:l.translator.trans("cryptofund-erc20-money.admin.settings.save_error");l.alerts.show({type:"error"},n),m.redraw()})},t.prototype.loadStatistics=function(){var e=this;return l.request({method:"GET",url:l.forum.attribute("apiUrl")+"/erc20-transactions?include=statistics"}).then(function(t){if(t.included&&t.included.length>0){var n=t.included.find(function(e){return"erc20-statistics"===e.type});n&&(e.statistics=n.attributes,m.redraw())}}).catch(function(e){console.error("Failed to load statistics:",e)})},t.prototype.testConnection=function(){var e=this;return this.testing=!0,this.testResult=null,l.request({method:"POST",url:l.forum.attribute("apiUrl")+"/erc20-test-connection",body:{data:{type:"erc20-test",attributes:{ethereum_rpc_url:this.ethereumRpcUrl()}}}}).then(function(t){e.testing=!1,e.testResult={success:!0,message:l.translator.trans("cryptofund-erc20-money.admin.settings.connection_success",{network:t.data.attributes.network_name,block:t.data.attributes.latest_block})},m.redraw()}).catch(function(t){e.testing=!1,e.testResult={success:!1,message:t.responseJSON&&t.responseJSON.errors&&t.responseJSON.errors[0]?t.responseJSON.errors[0].detail:l.translator.trans("cryptofund-erc20-money.admin.settings.connection_failed")},m.redraw()})},t.prototype.runManualCheck=function(){var e=this;return confirm(l.translator.trans("cryptofund-erc20-money.admin.settings.manual_check_confirm"))?l.request({method:"POST",url:l.forum.attribute("apiUrl")+"/erc20-check-transactions"}).then(function(t){l.alerts.show({type:"success"},l.translator.trans("cryptofund-erc20-money.admin.settings.manual_check_success",{processed:t.data.attributes.processed_count})),e.loadStatistics()}).catch(function(e){var t=e.responseJSON&&e.responseJSON.errors&&e.responseJSON.errors[0]?e.responseJSON.errors[0].detail:l.translator.trans("cryptofund-erc20-money.admin.settings.manual_check_failed");l.alerts.show({type:"error"},t)}):void 0},t}(c);l.initializers.add("cryptofund-erc20-money",function(){l.extensionData.for("cryptofund-erc20-money").registerPage(u)})})();
